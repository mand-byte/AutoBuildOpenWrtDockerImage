name: Build ImmortalWrt x86_64 with Passwall2, DDNS, UPnP

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      LAN_IP:
        description: 'LAN IP Address'
        required: false
        default: '192.168.1.1'

env:
  LAN_IP: ${{ vars.LAN_IP }}
  PPPoE_USERNAME: ${{ secrets.PPPOE_USERNAME }}
  PPPoE_PASSWORD: ${{ secrets.PPPOE_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget

      - name: Clone ImmortalWrt source code
        run: |
          git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add Passwall2 and update feeds
        working-directory: immortalwrt
        run: |
          echo "src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git;main" >> feeds.conf.default
          ./scripts/feeds update passwall2
          ./scripts/feeds install passwall2

      - name: Select Passwall2, DDNS, UPnP in .config
        working-directory: immortalwrt
        run: |
          cp -f target/linux/x86/64/config-5.15 .config || true
          make defconfig
          sed -i '/^# CONFIG_PACKAGE_luci-app-passwall2 is not set/a CONFIG_PACKAGE_luci-app-passwall2=y' .config
          sed -i '/^# CONFIG_PACKAGE_luci-app-ddns is not set/a CONFIG_PACKAGE_luci-app-ddns=y' .config
          sed -i '/^# CONFIG_PACKAGE_luci-app-upnp is not set/a CONFIG_PACKAGE_luci-app-upnp=y' .config
          make defconfig

      - name: Customize network config (LAN & PPPoE)
        working-directory: immortalwrt
        run: |
          mkdir -p files/etc/config
          cat > files/etc/config/network <<'EOF'
          config interface 'lan'
              option ifname 'eth0'
              option proto 'static'
              option ipaddr '${LAN_IP}'
              option netmask '255.255.255.0'
          
          config interface 'wan'
              option ifname 'eth1'
              option proto 'pppoe'
              option username '${PPPoE_USERNAME}'
              option password '${PPPoE_PASSWORD}'
          EOF

      - name: Build firmware
        working-directory: immortalwrt
        run: |
          make -j$(nproc) download V=s || make -j1 V=s download
          make -j$(nproc) V=s

      - name: Upload firmware to Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: monthly-build-${{ github.run_number }}
          name: "Monthly x86_64 Build ${{ github.run_number }}"
          body: |
            自动定时构建，目标平台 x86_64，集成 Passwall2、luci-app-ddns、luci-app-upnp。
            构建时间：${{ github.run_started_at }}
          files: |
            immortalwrt/bin/targets/x86/64/*.img.gz
            immortalwrt/bin/targets/x86/64/*.vmdk
            immortalwrt/bin/targets/x86/64/*.iso
            immortalwrt/bin/targets/x86/64/*.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
