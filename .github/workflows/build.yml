name: Build OpenWrt for x86-64

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 允许手动触发
    inputs:
      openwrt_version:
        description: 'OpenWrt 版本号 (例如 24.10.5)'
        required: true
        default: '24.10.5'
        type: string

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"

    - name: Update and install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath java-wrappers jq libelf-dev libffi-dev \
          libncurses5-dev libncursesw5-dev libssl-dev python3 python3-pyelftools \
          python3-setuptools unzip wget python3-dev zlib1g-dev bison flex \
          subversion quilt xsltproc gperf gengetopt liberror-perl \
          libgmp3-dev libmpc-dev libmpfr-dev texinfo patch curl \
          autoconf automake libtool pkg-config rsync kmod

    - name: Checkout OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        git checkout v${{ inputs.openwrt_version }}

    - name: Replace feeds.conf.default with GitHub mirrors (dynamic branch)
      run: |
        cd openwrt
        
        # 计算 feeds 分支名，例如 24.10.5 → openwrt-24.10
        MAJOR_MINOR=$(echo ${{ inputs.openwrt_version }} | cut -d. -f1-2)
        FEEDS_BRANCH="openwrt-${MAJOR_MINOR}"
        
        echo "Using OpenWrt version: ${{ inputs.openwrt_version }}"
        echo "Feeds branch: ${FEEDS_BRANCH}"
        
        # 备份原文件
        cp feeds.conf.default feeds.conf.default.bak
        
        # 动态替换 4 个官方 feeds 为 GitHub 镜像 + 分支
        sed -i "s|https://git.openwrt.org/feed/packages.git.*|https://github.com/openwrt/packages.git;${FEEDS_BRANCH}|" feeds.conf.default
        sed -i "s|https://git.openwrt.org/project/luci.git.*|https://github.com/openwrt/luci.git;${FEEDS_BRANCH}|" feeds.conf.default
        sed -i "s|https://git.openwrt.org/feed/routing.git.*|https://github.com/openwrt/routing.git;${FEEDS_BRANCH}|" feeds.conf.default
        sed -i "s|https://git.openwrt.org/feed/telephony.git.*|https://github.com/openwrt/telephony.git;${FEEDS_BRANCH}|" feeds.conf.default
        
        # 输出查看结果
        echo "Updated feeds.conf.default:"
        cat feeds.conf.default

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a

    - name: Install feeds
      run: |
        cd openwrt
        ./scripts/feeds install -a
        
    - name: Add TurboACC packages and patches
      run: |
        cd openwrt
        
        # 创建临时目录
        mkdir -p turboacc_tmp
        
        # 克隆 turboacc 仓库的 package 分支（包含补丁和依赖）
        git clone --depth=1 --branch package https://github.com/chenmozhijin/turboacc.git turboacc_tmp/turboacc
        
        # 复制 luci-app-turboacc
        cp -r turboacc_tmp/turboacc/luci-app-turboacc package/
        
        # 复制 nft-fullcone（全锥 NAT 依赖）
        cp -r turboacc_tmp/turboacc/nft-fullcone package/
        
        # 应用内核补丁（针对 OpenWrt 24.10 的 kernel 6.6）
        cp turboacc_tmp/turboacc/hack-6.6/952-add-net-conntrack-events-support-multiple-registrant.patch target/linux/generic/hack-6.6/
        cp turboacc_tmp/turboacc/hack-6.6/953-net-patch-linux-kernel-to-support-shortcut-fe.patch target/linux/generic/hack-6.6/
        # 如果要全锥 NAT 的额外补丁（可选，已包含在上面）
        # cp turboacc_tmp/turboacc/hack-6.6/613-nftables-fullcone-expression-support.patch target/linux/generic/hack-6.6/  # 如果有的话
        
        # 清理临时目录
        rm -rf turboacc_tmp
        
        # 更新 feeds（可选，但推荐）
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    - name: Copy custom .config
      run: |
        cp ../.config .config
        make defconfig
      working-directory: openwrt

    - name: Download dependencies
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_Firmware
        path: |
          openwrt/bin/targets/x86/64/*
          !openwrt/bin/targets/x86/64/*.buildinfo
          !openwrt/bin/targets/x86/64/*.manifest
